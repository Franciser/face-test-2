<!DOCTYPE html>
<html lang='zh-CN'>
    <head>
        <meta charset='UTF-8'>
        <meta http-equiv='X-UA-Compatible' content='ie=edge'>
        <meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
        <title>face-test-2</title>
        <link rel='stylesheet' href=''>
        <style>
            canvas {
                display: block;
                position: absolute;
                width: 100%;
                height: 100%;
            }
            video {
                display: block;
                position: absolute;
                top: 0;
                bottom: 0;
                left: 0;
                right: 0;
                width: 100%;
                height: 100%;
            }
            button {
                position: absolute;
                top: 20px;
                left: 20px;
            }
        </style>
    </head>
    <body>
        <video autoplay="" muted=""></video>
        <canvas width="783" height="11"></canvas>
        <button>开启摄像头</button>

        <script type="text/javascript" src="/js/ccv.js"></script>
        <script type="text/javascript" src="/js/face.js"></script>
        <script type='text/javascript'>
            try {
                    var localVideo = document.querySelector("video");
                    var localCanvas = document.querySelector("canvas");

                    function initialize() {
                        // try {
                        //     navigator.getUserMedia({
                        //         video: true
                        //     }, function (stream) {
                        //         localVideo.srcObject = stream;
                        //         localVideo.onplay = poll;
                        //     }, function (error) {
                        //         alert("Failed to get access to local media. Error code was " + error.code + ".");
                        //     });
                        // } catch (e) {
                        //     alert("getUserMedia error:", e);
                        // }

                        if (
                            navigator.mediaDevices.getUserMedia ||
                            navigator.getUserMedia ||
                            navigator.webkitGetUserMedia ||
                            navigator.mozGetUserMedia
                        ) {
                            // alert('可以打开摄像头')
                            if (navigator.mediaDevices.getUserMedia) {
                                //最新的标准API
                                navigator.mediaDevices
                                    .getUserMedia({video:true})
                                    .then((stream)=>{
                                        localVideo.srcObject = stream;
                                        localVideo.onplay = poll;
                                    })
                                    .catch((error)=>{
                                        alert("Failed to get access to local media. Error code was " + error.code + ".");
                                    });
                            } else if (navigator.webkitGetUserMedia) {
                                //webkit核心浏览器
                                navigator.webkitGetUserMedia({video:true}, 
                                    (stream)=>{
                                        localVideo.srcObject = stream;
                                        localVideo.onplay = poll;
                                    }, 
                                    (error) => {
                                        alert("Failed to get access to local media. Error code was " + error.code + ".");
                                    }
                                );
                            } else if (navigator.mozGetUserMedia) {
                                //firfox浏览器
                                navigator.mozGetUserMedia({video:true}, 
                                    (stream)=>{
                                        localVideo.srcObject = stream;
                                        localVideo.onplay = poll;
                                    }, 
                                    (error) => {
                                        alert("Failed to get access to local media. Error code was " + error.code + ".");
                                    }
                                );
                            } else if (navigator.getUserMedia) {
                                //旧版API
                                navigator.getUserMedia({video:true}, 
                                    (stream)=>{
                                        localVideo.srcObject = stream;
                                        localVideo.onplay = poll;
                                    }, 
                                    (error) => {
                                        alert("Failed to get access to local media. Error code was " + error.code + ".");
                                    }
                                );
                            }
                        } else {
                            alert("摄像头打开失败,请检查权限设置!")
                        }
                    }

                    function poll() {
                        var w = localVideo.videoWidth;
                        var h = localVideo.videoHeight;
                        var canvas = document.createElement('canvas');
                        canvas.width = w;
                        canvas.height = h;
                        var ctx = canvas.getContext('2d');
                        ctx.drawImage(localVideo, 0, 0, w, h);
                        var comp = ccv.detect_objects({
                            "canvas": ccv.grayscale(canvas),
                            "cascade": cascade,
                            "interval": 5,
                            "min_neighbors": 1
                        });
                        /* draw detected area */
                        localCanvas.width = localVideo.clientWidth;
                        localCanvas.height = localVideo.clientHeight;

                        var ctx2 = localCanvas.getContext('2d');
                        ctx2.lineWidth = 2;
                        ctx2.lineJoin = "round";
                        ctx2.clearRect(0, 0, localCanvas.width, localCanvas.height);

                        var x_offset = 0,
                            y_offset = 0,
                            x_scale = 1,
                            y_scale = 1;
                        if (localVideo.clientWidth * localVideo.videoHeight > localVideo.videoWidth * localVideo.clientHeight) {
                            x_offset = (localVideo.clientWidth - localVideo.clientHeight *
                                localVideo.videoWidth / localVideo.videoHeight) / 2;
                        } else {
                            y_offset = (localVideo.clientHeight - localVideo.clientWidth *
                                localVideo.videoHeight / localVideo.videoWidth) / 2;
                        }
                        x_scale = (localVideo.clientWidth - x_offset * 2) / localVideo.videoWidth;
                        y_scale = (localVideo.clientHeight - y_offset * 2) / localVideo.videoHeight;

                        for (var i = 0; i < comp.length; i++) {
                            comp[i].x = comp[i].x * x_scale + x_offset;
                            comp[i].y = comp[i].y * y_scale + y_offset;
                            comp[i].width = comp[i].width * x_scale;
                            comp[i].height = comp[i].height * y_scale;

                            var opacity = 0.1;
                            if (comp[i].confidence > 0) {
                                opacity += comp[i].confidence / 10;
                                if (opacity > 1.0) opacity = 1.0;
                            }

                            //ctx2.strokeStyle = "rgba(255,0,0," + opacity * 255 + ")";
                            ctx2.lineWidth = opacity * 10;
                            ctx2.strokeStyle = "rgb(255,0,0)";
                            ctx2.strokeRect(comp[i].x, comp[i].y, comp[i].width, comp[i].height);
                        }
                        setTimeout(poll, 500);
                    }

                    document.querySelector("button").onclick = initialize;
                } catch (error) {
                    throw error;
                }

        </script>
    </body>
</html>
